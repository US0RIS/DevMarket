<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CodeVault ‚Äî Buy & Sell Code</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,400&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #18181f;
    --border: #2a2a35;
    --accent: #00e5a0;
    --accent2: #7c6af5;
    --accent3: #ff6b6b;
    --text: #e8e8f0;
    --muted: #6b6b80;
    --code-bg: #0d0d14;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Syne', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grain overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 9999;
    opacity: 0.4;
  }

  /* NAV */
  nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.2rem 3rem;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: rgba(10,10,15,0.92);
    backdrop-filter: blur(20px);
    z-index: 100;
  }

  .logo {
    font-size: 1.4rem;
    font-weight: 800;
    letter-spacing: -0.03em;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
  }

  .logo span { color: var(--accent); }
  .logo-icon { font-size: 1.2rem; }

  .nav-actions {
    display: flex;
    gap: 0.75rem;
    align-items: center;
  }

  .btn {
    font-family: 'Syne', sans-serif;
    font-size: 0.85rem;
    font-weight: 600;
    padding: 0.55rem 1.2rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.01em;
  }

  .btn-ghost {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
  }
  .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }

  .btn-primary {
    background: var(--accent);
    color: #000;
  }
  .btn-primary:hover { background: #00ffc0; transform: translateY(-1px); }

  .btn-purple {
    background: var(--accent2);
    color: #fff;
  }
  .btn-purple:hover { background: #9585ff; transform: translateY(-1px); }

  .btn-danger {
    background: transparent;
    border: 1px solid var(--accent3);
    color: var(--accent3);
  }
  .btn-danger:hover { background: var(--accent3); color: #fff; }

  /* HERO */
  .hero {
    padding: 5rem 3rem 3rem;
    max-width: 900px;
    animation: fadeUp 0.6s ease both;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(24px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .hero h1 {
    font-size: clamp(2.5rem, 5vw, 4.5rem);
    font-weight: 800;
    line-height: 1.05;
    letter-spacing: -0.04em;
    margin-bottom: 1.2rem;
  }

  .hero h1 .hl { color: var(--accent); }
  .hero h1 .hl2 { color: var(--accent2); }

  .hero p {
    font-size: 1.05rem;
    color: var(--muted);
    max-width: 520px;
    line-height: 1.7;
    font-weight: 400;
    font-family: 'DM Mono', monospace;
  }

  /* STATS BAR */
  .stats-bar {
    display: flex;
    gap: 3rem;
    padding: 1.5rem 3rem;
    border-bottom: 1px solid var(--border);
    animation: fadeUp 0.6s 0.1s ease both;
  }

  .stat { display: flex; flex-direction: column; gap: 0.15rem; }
  .stat-val { font-size: 1.5rem; font-weight: 800; color: var(--accent); letter-spacing: -0.03em; }
  .stat-label { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; font-family: 'DM Mono', monospace; }

  /* MAIN LAYOUT */
  .main {
    display: grid;
    grid-template-columns: 260px 1fr;
    min-height: calc(100vh - 220px);
  }

  /* SIDEBAR */
  .sidebar {
    border-right: 1px solid var(--border);
    padding: 2rem 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 2rem;
    animation: fadeUp 0.6s 0.2s ease both;
  }

  .sidebar-section h3 {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--muted);
    margin-bottom: 0.8rem;
    font-family: 'DM Mono', monospace;
  }

  .filter-group { display: flex; flex-direction: column; gap: 0.4rem; }

  .filter-btn {
    font-family: 'Syne', sans-serif;
    font-size: 0.88rem;
    font-weight: 600;
    padding: 0.6rem 0.9rem;
    border-radius: 6px;
    border: 1px solid transparent;
    background: transparent;
    color: var(--muted);
    text-align: left;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .filter-btn:hover { color: var(--text); background: var(--surface2); }
  .filter-btn.active { background: var(--surface2); border-color: var(--accent); color: var(--accent); }

  .filter-badge {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    background: var(--border);
    border-radius: 20px;
    padding: 0.1rem 0.45rem;
    color: var(--muted);
  }

  /* CONTENT */
  .content {
    padding: 2rem 2.5rem;
    animation: fadeUp 0.6s 0.3s ease both;
  }

  .content-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
  }

  .content-header h2 {
    font-size: 1.2rem;
    font-weight: 700;
    letter-spacing: -0.02em;
  }

  .search-bar {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.55rem 1rem;
    width: 280px;
    transition: border-color 0.2s;
  }
  .search-bar:focus-within { border-color: var(--accent2); }
  .search-bar input {
    background: none;
    border: none;
    outline: none;
    font-family: 'DM Mono', monospace;
    font-size: 0.85rem;
    color: var(--text);
    width: 100%;
  }
  .search-bar input::placeholder { color: var(--muted); }
  .search-icon { color: var(--muted); font-size: 0.9rem; }

  /* GRID */
  .listings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.2rem;
  }

  /* CARD */
  .listing-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
  }
  .listing-card:hover {
    border-color: var(--accent2);
    transform: translateY(-3px);
    box-shadow: 0 12px 40px rgba(124,106,245,0.12);
  }

  .card-preview {
    background: var(--code-bg);
    padding: 1rem;
    height: 140px;
    overflow: hidden;
    position: relative;
    border-bottom: 1px solid var(--border);
  }

  .card-preview pre {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    line-height: 1.6;
    color: #8888aa;
    white-space: pre;
    overflow: hidden;
  }

  .card-preview-blur {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 60px;
    background: linear-gradient(transparent, var(--code-bg));
  }

  .lang-badge {
    position: absolute;
    top: 0.6rem;
    right: 0.6rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-weight: 500;
  }

  .lang-js { background: #1a1400; color: #f7df1e; border: 1px solid #3a3200; }
  .lang-py { background: #001a1a; color: #3776ab; border: 1px solid #003333; }
  .lang-ts { background: #00101a; color: #3178c6; border: 1px solid #001f33; }
  .lang-css { background: #0d001a; color: #264de4; border: 1px solid #1a003a; }
  .lang-html { background: #1a0800; color: #e44d26; border: 1px solid #3a1500; }
  .lang-other { background: var(--surface2); color: var(--muted); border: 1px solid var(--border); }

  .card-body { padding: 1rem; flex: 1; display: flex; flex-direction: column; gap: 0.5rem; }
  .card-title { font-size: 0.95rem; font-weight: 700; letter-spacing: -0.02em; }
  .card-desc { font-size: 0.78rem; color: var(--muted); line-height: 1.5; font-family: 'DM Mono', monospace; flex: 1; }

  .card-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 0.5rem;
    padding-top: 0.7rem;
    border-top: 1px solid var(--border);
  }

  .card-seller {
    font-size: 0.72rem;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
  }
  .card-seller strong { color: var(--accent2); }

  .card-prices { display: flex; flex-direction: column; align-items: flex-end; gap: 0.15rem; }
  .price-buy { font-size: 0.95rem; font-weight: 800; color: var(--accent); }
  .price-license { font-size: 0.7rem; color: var(--muted); font-family: 'DM Mono', monospace; }

  /* EMPTY STATE */
  .empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 4rem 2rem;
    color: var(--muted);
  }
  .empty-state .icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.4; }
  .empty-state p { font-family: 'DM Mono', monospace; font-size: 0.85rem; }

  /* MODAL BASE */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(6px);
    z-index: 200;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    transform: scale(0.96) translateY(16px);
    transition: transform 0.25s;
  }
  .modal-overlay.open .modal { transform: scale(1) translateY(0); }

  .modal-sm { max-width: 500px; }
  .modal-lg { max-width: 820px; }
  .modal-xl { max-width: 1000px; }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem 1.8rem;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: var(--surface);
    z-index: 5;
  }

  .modal-header h2 { font-size: 1.1rem; font-weight: 700; letter-spacing: -0.02em; }

  .close-btn {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 1.2rem;
    line-height: 1;
    padding: 0.3rem;
    border-radius: 4px;
    transition: color 0.15s;
  }
  .close-btn:hover { color: var(--text); }

  .modal-body { padding: 1.8rem; }

  /* FORM */
  .form-group { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.2rem; }
  .form-label {
    font-size: 0.78rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
  }

  .form-input, .form-select, .form-textarea {
    font-family: 'DM Mono', monospace;
    font-size: 0.88rem;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.7rem 0.9rem;
    color: var(--text);
    outline: none;
    transition: border-color 0.15s;
    width: 100%;
  }
  .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent2); }
  .form-select option { background: var(--surface2); }
  .form-textarea { min-height: 80px; resize: vertical; }

  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

  /* CODE UPLOAD */
  .code-drop-zone {
    border: 2px dashed var(--border);
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }
  .code-drop-zone:hover, .code-drop-zone.dragover {
    border-color: var(--accent2);
    background: rgba(124,106,245,0.05);
  }
  .code-drop-zone input[type=file] {
    position: absolute; inset: 0; opacity: 0; cursor: pointer;
  }
  .drop-icon { font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5; }
  .drop-text { font-size: 0.82rem; color: var(--muted); font-family: 'DM Mono', monospace; }
  .drop-text strong { color: var(--accent2); }

  .code-editor-wrap {
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }
  .code-editor-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.6rem 1rem;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
  }
  .dot { width: 10px; height: 10px; border-radius: 50%; }
  .dot-r { background: #ff5f57; } .dot-y { background: #febc2e; } .dot-g { background: #28c840; }
  .code-filename {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
    margin-left: 0.5rem;
  }

  .code-textarea {
    width: 100%;
    min-height: 220px;
    background: var(--code-bg);
    border: none;
    padding: 1rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.82rem;
    line-height: 1.65;
    color: #b8c0cc;
    outline: none;
    resize: vertical;
  }

  /* LISTING DETAIL */
  .detail-grid { display: grid; grid-template-columns: 1fr 320px; gap: 1.5rem; }

  .detail-code-preview {
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }
  .detail-code-preview pre {
    padding: 1.2rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.78rem;
    line-height: 1.65;
    color: #8888aa;
    overflow-x: auto;
    max-height: 400px;
    overflow-y: auto;
  }

  .detail-sidebar { display: flex; flex-direction: column; gap: 1rem; }

  .price-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.2rem;
  }
  .price-card-title {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    margin-bottom: 0.6rem;
  }
  .price-amount { font-size: 2rem; font-weight: 800; letter-spacing: -0.04em; margin-bottom: 0.3rem; }
  .price-desc { font-size: 0.75rem; color: var(--muted); font-family: 'DM Mono', monospace; margin-bottom: 1rem; line-height: 1.5; }

  .divider { height: 1px; background: var(--border); margin: 1rem 0; }

  .tag-list { display: flex; flex-wrap: wrap; gap: 0.4rem; }
  .tag {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    padding: 0.2rem 0.6rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    color: var(--muted);
  }

  .seller-info {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    padding: 1rem;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
  }
  .seller-avatar {
    width: 40px; height: 40px;
    border-radius: 8px;
    background: linear-gradient(135deg, var(--accent2), var(--accent));
    display: flex; align-items: center; justify-content: center;
    font-weight: 800; font-size: 1rem;
    flex-shrink: 0;
  }
  .seller-name { font-size: 0.9rem; font-weight: 700; }
  .seller-join { font-family: 'DM Mono', monospace; font-size: 0.7rem; color: var(--muted); }

  /* OFFERS SECTION */
  .offers-section { margin-top: 1.2rem; }
  .offers-section h3 { font-size: 0.85rem; font-weight: 700; margin-bottom: 0.8rem; }

  .offer-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.9rem 1rem;
    margin-bottom: 0.6rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .offer-info { display: flex; flex-direction: column; gap: 0.2rem; }
  .offer-buyer { font-size: 0.82rem; font-weight: 600; }
  .offer-type {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    padding: 0.15rem 0.4rem;
    border-radius: 3px;
    display: inline-block;
    margin-top: 0.15rem;
  }
  .offer-type-buy { background: rgba(0,229,160,0.1); color: var(--accent); }
  .offer-type-license { background: rgba(124,106,245,0.1); color: var(--accent2); }
  .offer-amount { font-size: 1.1rem; font-weight: 800; color: var(--accent); }
  .offer-actions { display: flex; gap: 0.4rem; margin-top: 0.4rem; }

  .offer-status-badge {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
  }
  .badge-pending { background: rgba(255,193,7,0.1); color: #ffc107; border: 1px solid rgba(255,193,7,0.2); }
  .badge-accepted { background: rgba(0,229,160,0.1); color: var(--accent); border: 1px solid rgba(0,229,160,0.2); }
  .badge-declined { background: rgba(255,107,107,0.1); color: var(--accent3); border: 1px solid rgba(255,107,107,0.2); }

  /* NOTIFICATION TOAST */
  .toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: var(--surface2);
    border: 1px solid var(--accent);
    border-radius: 8px;
    padding: 0.9rem 1.4rem;
    font-size: 0.85rem;
    font-family: 'DM Mono', monospace;
    z-index: 999;
    transform: translateY(20px);
    opacity: 0;
    transition: all 0.3s;
    max-width: 320px;
  }
  .toast.show { transform: translateY(0); opacity: 1; }

  /* MY DASHBOARD */
  .dashboard-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
  .tab-btn {
    font-family: 'Syne', sans-serif;
    font-size: 0.85rem;
    font-weight: 600;
    padding: 0.55rem 1.2rem;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.15s;
  }
  .tab-btn.active { background: var(--surface2); border-color: var(--accent2); color: var(--accent2); }
  .tab-btn:hover { color: var(--text); }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  .listing-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 0.6rem;
  }
  .listing-row-info { flex: 1; }
  .listing-row-title { font-size: 0.9rem; font-weight: 700; }
  .listing-row-meta { font-size: 0.73rem; color: var(--muted); font-family: 'DM Mono', monospace; margin-top: 0.2rem; }
  .listing-row-price { font-size: 1rem; font-weight: 800; color: var(--accent); white-space: nowrap; }
  .listing-row-actions { display: flex; gap: 0.4rem; }

  /* SYNTAX COLORS */
  .kw { color: #c792ea; }
  .fn { color: #82aaff; }
  .str { color: #c3e88d; }
  .num { color: #f78c6c; }
  .cmt { color: #546e7a; font-style: italic; }
  .op { color: #89ddff; }

  /* scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

  .hidden { display: none !important; }

  /* User badge in nav */
  .user-badge {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    padding: 0.4rem 0.8rem;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.82rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
  }
  .user-badge:hover { border-color: var(--accent2); }
  .user-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); }

  .btn-sm { padding: 0.35rem 0.75rem; font-size: 0.78rem; }
  .full-width { width: 100%; }
  .mt-sm { margin-top: 0.5rem; }

  .info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.8rem;
    padding: 0.4rem 0;
  }
  .info-row .label { color: var(--muted); font-family: 'DM Mono', monospace; }
  .info-row .value { font-weight: 600; }

  /* make modal body scroll nicely */
  .modal { scrollbar-width: thin; }

  @media (max-width: 768px) {
    nav { padding: 1rem 1.2rem; }
    .hero { padding: 2.5rem 1.2rem 1.5rem; }
    .stats-bar { padding: 1rem 1.2rem; gap: 1.5rem; flex-wrap: wrap; }
    .main { grid-template-columns: 1fr; }
    .sidebar { display: none; }
    .content { padding: 1.5rem 1.2rem; }
    .detail-grid { grid-template-columns: 1fr; }
    .form-row { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <div class="logo" onclick="showView('home')">
    <span class="logo-icon">‚¨°</span> Code<span>Vault</span>
  </div>
  <div class="nav-actions" id="nav-actions">
    <button class="btn btn-ghost" onclick="showModal('login-modal')">Sign In</button>
    <button class="btn btn-primary" onclick="showModal('register-modal')">Join Free</button>
  </div>
</nav>

<!-- HERO -->
<div class="hero" id="hero-section">
  <h1>The marketplace for<br><span class="hl">developer-crafted</span><br><span class="hl2">code.</span></h1>
  <p>Upload your scripts, components, and tools. Buyers can preview, negotiate, and license ‚Äî directly from developers.</p>
</div>

<!-- STATS BAR -->
<div class="stats-bar" id="stats-bar">
  <div class="stat">
    <div class="stat-val" id="stat-listings">0</div>
    <div class="stat-label">listings</div>
  </div>
  <div class="stat">
    <div class="stat-val" id="stat-sellers">0</div>
    <div class="stat-label">sellers</div>
  </div>
  <div class="stat">
    <div class="stat-val" id="stat-offers">0</div>
    <div class="stat-label">offers made</div>
  </div>
</div>

<!-- MAIN -->
<div class="main">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-section">
      <h3>Language</h3>
      <div class="filter-group" id="lang-filters">
        <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">All <span class="filter-badge" id="fb-all">0</span></button>
        <button class="filter-btn" data-filter="JavaScript" onclick="setFilter('JavaScript')">JavaScript <span class="filter-badge" id="fb-js">0</span></button>
        <button class="filter-btn" data-filter="Python" onclick="setFilter('Python')">Python <span class="filter-badge" id="fb-py">0</span></button>
        <button class="filter-btn" data-filter="TypeScript" onclick="setFilter('TypeScript')">TypeScript <span class="filter-badge" id="fb-ts">0</span></button>
        <button class="filter-btn" data-filter="CSS" onclick="setFilter('CSS')">CSS <span class="filter-badge" id="fb-css">0</span></button>
        <button class="filter-btn" data-filter="HTML" onclick="setFilter('HTML')">HTML <span class="filter-badge" id="fb-html">0</span></button>
        <button class="filter-btn" data-filter="Other" onclick="setFilter('Other')">Other <span class="filter-badge" id="fb-other">0</span></button>
      </div>
    </div>
    <div class="sidebar-section">
      <h3>Sort By</h3>
      <div class="filter-group">
        <button class="filter-btn active" id="sort-newest" onclick="setSort('newest')">Newest First</button>
        <button class="filter-btn" id="sort-price-low" onclick="setSort('price-low')">Price: Low ‚Üí High</button>
        <button class="filter-btn" id="sort-price-high" onclick="setSort('price-high')">Price: High ‚Üí Low</button>
      </div>
    </div>
  </aside>

  <!-- CONTENT -->
  <div class="content">
    <div class="content-header">
      <h2 id="content-title">Browse Listings</h2>
      <div style="display:flex;gap:0.7rem;align-items:center;">
        <div class="search-bar">
          <span class="search-icon">‚åï</span>
          <input type="text" placeholder="Search listings..." id="search-input" oninput="renderListings()">
        </div>
        <button class="btn btn-primary hidden" id="sell-btn" onclick="showModal('sell-modal')">+ Sell Code</button>
      </div>
    </div>
    <div class="listings-grid" id="listings-grid"></div>
  </div>
</div>

<!-- ===== MODALS ===== -->

<!-- LOGIN -->
<div class="modal-overlay" id="login-modal">
  <div class="modal modal-sm">
    <div class="modal-header">
      <h2>Sign in to CodeVault</h2>
      <button class="close-btn" onclick="closeModal('login-modal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Username</label>
        <input class="form-input" id="login-username" placeholder="your username" autocomplete="off">
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input class="form-input" type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <button class="btn btn-primary full-width" onclick="doLogin()" style="margin-top:0.5rem;">Sign In</button>
      <div style="text-align:center;margin-top:1rem;font-size:0.82rem;color:var(--muted);font-family:'DM Mono',monospace;">
        No account? <a href="#" onclick="closeModal('login-modal');showModal('register-modal')" style="color:var(--accent2);">Register free</a>
      </div>
    </div>
  </div>
</div>

<!-- REGISTER -->
<div class="modal-overlay" id="register-modal">
  <div class="modal modal-sm">
    <div class="modal-header">
      <h2>Create Account</h2>
      <button class="close-btn" onclick="closeModal('register-modal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Display Name</label>
        <input class="form-input" id="reg-name" placeholder="e.g. devmatt">
      </div>
      <div class="form-group">
        <label class="form-label">Username</label>
        <input class="form-input" id="reg-username" placeholder="unique username">
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input class="form-input" type="password" id="reg-password" placeholder="min 6 characters">
      </div>
      <button class="btn btn-primary full-width mt-sm" onclick="doRegister()">Create Account</button>
    </div>
  </div>
</div>

<!-- SELL / UPLOAD -->
<div class="modal-overlay" id="sell-modal">
  <div class="modal modal-lg">
    <div class="modal-header">
      <h2>List Code for Sale</h2>
      <button class="close-btn" onclick="closeModal('sell-modal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Title</label>
        <input class="form-input" id="sell-title" placeholder="e.g. Lightweight Drag & Drop Library">
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-textarea" id="sell-desc" placeholder="What does your code do? What problem does it solve?"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Language</label>
          <select class="form-select" id="sell-lang">
            <option>JavaScript</option>
            <option>TypeScript</option>
            <option>Python</option>
            <option>CSS</option>
            <option>HTML</option>
            <option>Other</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Tags (comma separated)</label>
          <input class="form-input" id="sell-tags" placeholder="e.g. utility, animation, react">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Full Purchase Price (USD)</label>
          <input class="form-input" id="sell-price" type="number" min="1" placeholder="e.g. 49">
        </div>
        <div class="form-group">
          <label class="form-label">License Price / mo (USD) <span style="color:var(--muted);font-size:0.75rem;font-weight:400;">optional</span></label>
          <input class="form-input" id="sell-license" type="number" min="1" placeholder="e.g. 9">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Code</label>
        <div class="code-drop-zone" id="drop-zone" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="handleFileDrop(event)">
          <input type="file" id="file-input" accept=".js,.ts,.py,.css,.html,.txt,.json,.jsx,.tsx,.vue,.rb,.go,.rs,.php,.java,.cs,.cpp,.c" onchange="handleFileSelect(event)">
          <div class="drop-icon">‚Üë</div>
          <div class="drop-text">Drop a file here or <strong>click to browse</strong></div>
        </div>
        <div class="code-editor-wrap" style="margin-top:0.6rem;">
          <div class="code-editor-header">
            <div class="dot dot-r"></div><div class="dot dot-y"></div><div class="dot dot-g"></div>
            <span class="code-filename" id="editor-filename">untitled</span>
          </div>
          <textarea class="code-textarea" id="sell-code" placeholder="// Or paste your code here..."></textarea>
        </div>
      </div>
      <button class="btn btn-primary full-width mt-sm" onclick="doSellSubmit()">Publish Listing ‚Üí</button>
    </div>
  </div>
</div>

<!-- LISTING DETAIL -->
<div class="modal-overlay" id="detail-modal">
  <div class="modal modal-xl">
    <div class="modal-header">
      <div>
        <h2 id="detail-title">Listing</h2>
        <div style="font-size:0.73rem;color:var(--muted);font-family:'DM Mono',monospace;margin-top:0.2rem;" id="detail-meta-line"></div>
      </div>
      <button class="close-btn" onclick="closeModal('detail-modal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="detail-grid">
        <div>
          <div class="detail-code-preview" id="detail-code-wrap">
            <div class="code-editor-header">
              <div class="dot dot-r"></div><div class="dot dot-y"></div><div class="dot dot-g"></div>
              <span class="code-filename" id="detail-lang-badge">preview</span>
              <span style="margin-left:auto;font-family:'DM Mono',monospace;font-size:0.68rem;color:var(--muted);">‚ö† blurred for non-buyers</span>
            </div>
            <pre id="detail-code-preview"></pre>
          </div>
          <div style="margin-top:1rem;">
            <p style="font-size:0.88rem;color:var(--muted);line-height:1.6;font-family:'DM Mono',monospace;" id="detail-desc"></p>
          </div>
          <div style="margin-top:1rem;" id="detail-tags-wrap">
            <div class="tag-list" id="detail-tags"></div>
          </div>

          <!-- Offer form for buyers -->
          <div id="offer-form-section" style="margin-top:1.5rem;display:none;">
            <div class="divider"></div>
            <h3 style="font-size:0.9rem;font-weight:700;margin-bottom:1rem;">Make an Offer</h3>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Offer Type</label>
                <select class="form-select" id="offer-type">
                  <option value="buy">Full Purchase</option>
                  <option value="license">License (monthly)</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Your Offer (USD)</label>
                <input class="form-input" id="offer-amount" type="number" min="1" placeholder="e.g. 40">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Message (optional)</label>
              <input class="form-input" id="offer-message" placeholder="Any context or questions...">
            </div>
            <button class="btn btn-purple full-width" onclick="submitOffer()">Submit Offer ‚Üí</button>
          </div>

          <!-- Seller's offers view -->
          <div id="seller-offers-section" style="margin-top:1.5rem;display:none;">
            <div class="divider"></div>
            <div class="offers-section">
              <h3>Offers Received</h3>
              <div id="seller-offers-list"></div>
            </div>
          </div>

          <!-- Login prompt -->
          <div id="login-prompt-section" style="margin-top:1.5rem;display:none;">
            <div class="divider"></div>
            <div style="text-align:center;padding:1.5rem;background:var(--surface2);border-radius:8px;border:1px solid var(--border);">
              <div style="font-size:1.5rem;margin-bottom:0.5rem;">üîí</div>
              <div style="font-size:0.85rem;color:var(--muted);font-family:'DM Mono',monospace;margin-bottom:1rem;">Sign in to make offers on this listing</div>
              <button class="btn btn-primary" onclick="closeModal('detail-modal');showModal('login-modal')">Sign In to Make Offer</button>
            </div>
          </div>
        </div>

        <div class="detail-sidebar">
          <!-- Buy price card -->
          <div class="price-card" id="price-buy-card">
            <div class="price-card-title">Full Purchase</div>
            <div class="price-amount" id="detail-buy-price" style="color:var(--accent);">‚Äî</div>
            <div class="price-desc">One-time payment. You own the code. Includes all future updates.</div>
            <button class="btn btn-primary full-width btn-sm" id="quick-buy-btn" onclick="quickAction('buy')">Buy Now</button>
          </div>

          <!-- License price card -->
          <div class="price-card" id="price-license-card" style="display:none;">
            <div class="price-card-title">License</div>
            <div class="price-amount" id="detail-license-price" style="color:var(--accent2);">‚Äî</div>
            <div class="price-desc">Monthly license. Use it in your projects. Cancel any time.</div>
            <button class="btn btn-purple full-width btn-sm" onclick="quickAction('license')">License It</button>
          </div>

          <div class="seller-info">
            <div class="seller-avatar" id="detail-avatar"></div>
            <div>
              <div class="seller-name" id="detail-seller-name"></div>
              <div class="seller-join">Seller ¬∑ CodeVault</div>
            </div>
          </div>

          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:1rem;">
            <div class="info-row"><span class="label">Language</span><span class="value" id="detail-info-lang"></span></div>
            <div class="info-row"><span class="label">Listed</span><span class="value" id="detail-info-date"></span></div>
            <div class="info-row"><span class="label">Offers</span><span class="value" id="detail-info-offers">0</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div class="modal-overlay" id="dashboard-modal">
  <div class="modal modal-xl">
    <div class="modal-header">
      <h2>My Dashboard</h2>
      <button class="close-btn" onclick="closeModal('dashboard-modal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="dashboard-tabs">
        <button class="tab-btn active" onclick="switchTab('my-listings')">My Listings</button>
        <button class="tab-btn" onclick="switchTab('my-offers')">Offers I Made</button>
      </div>
      <div class="tab-content active" id="tab-my-listings">
        <div style="display:flex;justify-content:flex-end;margin-bottom:1rem;">
          <button class="btn btn-primary" onclick="closeModal('dashboard-modal');showModal('sell-modal')">+ New Listing</button>
        </div>
        <div id="my-listings-list"></div>
      </div>
      <div class="tab-content" id="tab-my-offers">
        <div id="my-offers-list"></div>
      </div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ============================================================
// STATE
// ============================================================
let db = {
  users: [],
  listings: [],
  offers: []
};

let currentUser = null;
let activeFilter = 'all';
let activeSort = 'newest';
let currentListingId = null;

// ============================================================
// PERSISTENCE
// ============================================================
function save() {
  try { localStorage.setItem('codevault_db', JSON.stringify(db)); } catch(e) {}
}
function load() {
  try {
    const raw = localStorage.getItem('codevault_db');
    if (raw) db = JSON.parse(raw);
  } catch(e) {}
  // Seed demo data if empty
  if (db.listings.length === 0) seedDemo();
}

function seedDemo() {
  const seller = { id: 'u1', name: 'devmatt', username: 'devmatt', password: 'demo', joined: Date.now() - 1000000 };
  db.users.push(seller);

  const demos = [
    {
      id: 'l1', sellerId: 'u1', title: 'Infinite Scroll Hook',
      desc: 'A reusable React hook that adds infinite scroll to any list. Zero dependencies, TypeScript support, configurable threshold.',
      lang: 'TypeScript', tags: ['react','hooks','scroll','typescript'],
      buyPrice: 39, licensePrice: 8,
      code: `import { useEffect, useRef, useState } from 'react';

interface UseInfiniteScrollOptions {
  threshold?: number;
  rootMargin?: string;
}

export function useInfiniteScroll(
  callback: () => void,
  options: UseInfiniteScrollOptions = {}
) {
  const { threshold = 1.0, rootMargin = '0px' } = options;
  const observer = useRef<IntersectionObserver | null>(null);
  const [sentinel, setSentinel] = useState<HTMLDivElement | null>(null);

  useEffect(() => {
    if (!sentinel) return;
    observer.current = new IntersectionObserver(
      ([entry]) => { if (entry.isIntersecting) callback(); },
      { threshold, rootMargin }
    );
    observer.current.observe(sentinel);
    return () => observer.current?.disconnect();
  }, [sentinel, callback, threshold, rootMargin]);

  return { ref: setSentinel };
}`,
      listed: Date.now() - 500000
    },
    {
      id: 'l2', sellerId: 'u1', title: 'Smooth Parallax Engine',
      desc: 'Pure CSS + JS parallax that works on any element. Supports mobile, GPU-accelerated, no jank. Drop in 2 lines.',
      lang: 'JavaScript', tags: ['animation','css','performance','scroll'],
      buyPrice: 25, licensePrice: 5,
      code: `class ParallaxEngine {
  constructor(selector = '[data-parallax]', options = {}) {
    this.elements = [];
    this.options = { speed: 0.5, clamp: true, ...options };
    this.raf = null;
    this._init(selector);
  }

  _init(selector) {
    document.querySelectorAll(selector).forEach(el => {
      this.elements.push({
        el,
        speed: parseFloat(el.dataset.parallaxSpeed) || this.options.speed,
        origin: el.getBoundingClientRect().top + window.scrollY
      });
    });
    window.addEventListener('scroll', () => this._tick(), { passive: true });
    this._tick();
  }

  _tick() {
    if (this.raf) return;
    this.raf = requestAnimationFrame(() => {
      const scrollY = window.scrollY;
      this.elements.forEach(({ el, speed, origin }) => {
        const offset = (scrollY - origin) * speed;
        el.style.transform = \`translateY(\${offset}px)\`;
      });
      this.raf = null;
    });
  }
}

// Usage: new ParallaxEngine('[data-parallax]', { speed: 0.3 });`,
      listed: Date.now() - 200000
    },
    {
      id: 'l3', sellerId: 'u1', title: 'CSS Grid Layout Builder',
      desc: 'Generate complex responsive CSS grid layouts with one function. Supports named areas, auto-placement, and media queries.',
      lang: 'CSS', tags: ['css','grid','responsive','layout'],
      buyPrice: 15, licensePrice: null,
      code: `/* =====================
   Auto-Responsive Grid System
   No JavaScript required
   ===================== */

.grid {
  display: grid;
  grid-template-columns: repeat(
    auto-fill,
    minmax(var(--grid-min, 240px), 1fr)
  );
  gap: var(--grid-gap, 1.5rem);
  container-type: inline-size;
}

/* Named layout areas */
.layout-blog {
  display: grid;
  grid-template:
    "header  header" auto
    "sidebar main  " 1fr
    "footer  footer" auto
    / 260px  1fr;
  gap: 1.5rem;
  min-height: 100vh;
}

@container (max-width: 640px) {
  .layout-blog {
    grid-template:
      "header"
      "main"
      "sidebar"
      "footer";
  }
}`,
      listed: Date.now() - 100000
    },
    {
      id: 'l4', sellerId: 'u1', title: 'Python Data Pipeline CLI',
      desc: 'Command-line ETL tool for CSV/JSON transforms. Chained transforms, validation, progress bars, configurable output formats.',
      lang: 'Python', tags: ['cli','data','etl','python'],
      buyPrice: 79, licensePrice: 15,
      code: `#!/usr/bin/env python3
"""DataPipe ‚Äî lightweight ETL for CSV/JSON"""

import csv, json, argparse, sys
from typing import Generator, Callable
from pathlib import Path

class Pipeline:
    def __init__(self, source: str):
        self.source = Path(source)
        self._transforms: list[Callable] = []

    def transform(self, fn: Callable) -> 'Pipeline':
        self._transforms.append(fn)
        return self

    def _read(self) -> Generator:
        suffix = self.source.suffix.lower()
        if suffix == '.csv':
            with open(self.source) as f:
                yield from csv.DictReader(f)
        elif suffix == '.json':
            with open(self.source) as f:
                data = json.load(f)
                yield from (data if isinstance(data, list) else [data])
        else:
            raise ValueError(f"Unsupported format: {suffix}")

    def run(self, output: str = None) -> list:
        results = []
        for row in self._read():
            for fn in self._transforms:
                row = fn(row)
                if row is None:
                    break
            if row is not None:
                results.append(row)
        if output:
            with open(output, 'w') as f:
                json.dump(results, f, indent=2)
        return results`,
      listed: Date.now() - 50000
    }
  ];

  demos.forEach(l => db.listings.push(l));
  save();
}

// ============================================================
// AUTH
// ============================================================
function doLogin() {
  const u = document.getElementById('login-username').value.trim();
  const p = document.getElementById('login-password').value;
  const user = db.users.find(x => x.username === u && x.password === p);
  if (!user) { toast('‚ùå Invalid username or password'); return; }
  currentUser = user;
  closeModal('login-modal');
  updateNav();
  renderListings();
  toast('‚úì Signed in as ' + user.name);
}

function doRegister() {
  const name = document.getElementById('reg-name').value.trim();
  const username = document.getElementById('reg-username').value.trim();
  const pass = document.getElementById('reg-password').value;
  if (!name || !username || !pass) { toast('‚ùå All fields required'); return; }
  if (pass.length < 6) { toast('‚ùå Password must be 6+ characters'); return; }
  if (db.users.find(x => x.username === username)) { toast('‚ùå Username already taken'); return; }
  const user = { id: 'u' + Date.now(), name, username, password: pass, joined: Date.now() };
  db.users.push(user);
  save();
  currentUser = user;
  closeModal('register-modal');
  updateNav();
  toast('‚úì Account created! Welcome, ' + name);
}

function doLogout() {
  currentUser = null;
  updateNav();
  renderListings();
  toast('Signed out');
}

function updateNav() {
  const el = document.getElementById('nav-actions');
  const sellBtn = document.getElementById('sell-btn');
  if (currentUser) {
    el.innerHTML = `
      <div class="user-badge" onclick="showDashboard()">
        <div class="user-dot"></div>
        ${currentUser.name}
      </div>
      <button class="btn btn-primary" onclick="showModal('sell-modal')">+ Sell Code</button>
      <button class="btn btn-ghost" onclick="doLogout()">Sign Out</button>
    `;
  } else {
    el.innerHTML = `
      <button class="btn btn-ghost" onclick="showModal('login-modal')">Sign In</button>
      <button class="btn btn-primary" onclick="showModal('register-modal')">Join Free</button>
    `;
  }
}

// ============================================================
// SELL / UPLOAD
// ============================================================
function handleFileDrop(e) {
  e.preventDefault();
  document.getElementById('drop-zone').classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) readFile(file);
}
function handleFileSelect(e) {
  const file = e.target.files[0];
  if (file) readFile(file);
}
function readFile(file) {
  const reader = new FileReader();
  reader.onload = ev => {
    document.getElementById('sell-code').value = ev.target.result;
    document.getElementById('editor-filename').textContent = file.name;
    // auto-detect language
    const ext = file.name.split('.').pop().toLowerCase();
    const map = { js:'JavaScript', jsx:'JavaScript', ts:'TypeScript', tsx:'TypeScript', py:'Python', css:'CSS', html:'HTML' };
    const sel = document.getElementById('sell-lang');
    sel.value = map[ext] || 'Other';
  };
  reader.readAsText(file);
}

function doSellSubmit() {
  if (!currentUser) { toast('‚ùå Sign in first'); return; }
  const title = document.getElementById('sell-title').value.trim();
  const desc = document.getElementById('sell-desc').value.trim();
  const lang = document.getElementById('sell-lang').value;
  const tagsRaw = document.getElementById('sell-tags').value;
  const buyPrice = parseFloat(document.getElementById('sell-price').value);
  const licenseRaw = document.getElementById('sell-license').value;
  const code = document.getElementById('sell-code').value.trim();

  if (!title) { toast('‚ùå Title required'); return; }
  if (!desc) { toast('‚ùå Description required'); return; }
  if (!code) { toast('‚ùå Paste or upload your code'); return; }
  if (!buyPrice || buyPrice < 1) { toast('‚ùå Set a purchase price'); return; }

  const listing = {
    id: 'l' + Date.now(),
    sellerId: currentUser.id,
    title, desc, lang,
    tags: tagsRaw.split(',').map(t => t.trim()).filter(Boolean),
    buyPrice,
    licensePrice: licenseRaw ? parseFloat(licenseRaw) : null,
    code,
    listed: Date.now()
  };
  db.listings.push(listing);
  save();
  closeModal('sell-modal');
  clearSellForm();
  renderListings();
  updateStats();
  toast('‚úì Listing published!');
}

function clearSellForm() {
  ['sell-title','sell-desc','sell-tags','sell-price','sell-license','sell-code'].forEach(id => {
    document.getElementById(id).value = '';
  });
  document.getElementById('editor-filename').textContent = 'untitled';
}

// ============================================================
// LISTINGS RENDER
// ============================================================
function setFilter(f) {
  activeFilter = f;
  document.querySelectorAll('[data-filter]').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === f));
  renderListings();
}

function setSort(s) {
  activeSort = s;
  document.querySelectorAll('[id^="sort-"]').forEach(btn => btn.classList.remove('active'));
  document.getElementById('sort-' + s)?.classList.add('active');
  renderListings();
}

function getLangClass(lang) {
  const map = { JavaScript:'lang-js', Python:'lang-py', TypeScript:'lang-ts', CSS:'lang-css', HTML:'lang-html' };
  return map[lang] || 'lang-other';
}

function renderListings() {
  const grid = document.getElementById('listings-grid');
  const search = document.getElementById('search-input').value.toLowerCase();
  let items = [...db.listings];

  if (activeFilter !== 'all') items = items.filter(l => l.lang === activeFilter);
  if (search) items = items.filter(l =>
    l.title.toLowerCase().includes(search) ||
    l.desc.toLowerCase().includes(search) ||
    (l.tags || []).some(t => t.toLowerCase().includes(search))
  );

  if (activeSort === 'newest') items.sort((a,b) => b.listed - a.listed);
  else if (activeSort === 'price-low') items.sort((a,b) => a.buyPrice - b.buyPrice);
  else if (activeSort === 'price-high') items.sort((a,b) => b.buyPrice - a.buyPrice);

  if (items.length === 0) {
    grid.innerHTML = `<div class="empty-state"><div class="icon">‚¨°</div><p>No listings found.<br>${currentUser ? 'Be the first to list code!' : 'Sign up and list your code.'}</p></div>`;
    return;
  }

  grid.innerHTML = items.map(l => {
    const seller = db.users.find(u => u.id === l.sellerId);
    const preview = blurCode(l.code.slice(0, 400));
    const offerCount = db.offers.filter(o => o.listingId === l.id).length;
    return `
    <div class="listing-card" onclick="openDetail('${l.id}')">
      <div class="card-preview">
        <span class="lang-badge ${getLangClass(l.lang)}">${l.lang}</span>
        <pre>${escapeHtml(preview)}</pre>
        <div class="card-preview-blur"></div>
      </div>
      <div class="card-body">
        <div class="card-title">${escapeHtml(l.title)}</div>
        <div class="card-desc">${escapeHtml(l.desc.slice(0, 90))}${l.desc.length > 90 ? '‚Ä¶' : ''}</div>
        <div class="card-meta">
          <div class="card-seller">by <strong>${seller?.name || 'unknown'}</strong></div>
          <div class="card-prices">
            <div class="price-buy">$${l.buyPrice}</div>
            ${l.licensePrice ? `<div class="price-license">$${l.licensePrice}/mo license</div>` : ''}
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
}

function blurCode(code) {
  // Show first 3 lines clearly, blur rest with hashes
  const lines = code.split('\n');
  return lines.slice(0, 3).join('\n') + '\n' + lines.slice(3).map(() => '‚ñà'.repeat(Math.floor(Math.random()*30+10))).join('\n');
}

function escapeHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ============================================================
// DETAIL MODAL
// ============================================================
function openDetail(listingId) {
  currentListingId = listingId;
  const l = db.listings.find(x => x.id === listingId);
  if (!l) return;
  const seller = db.users.find(u => u.id === l.sellerId);
  const offerCount = db.offers.filter(o => o.listingId === listingId).length;
  const isSeller = currentUser && currentUser.id === l.sellerId;

  document.getElementById('detail-title').textContent = l.title;
  document.getElementById('detail-meta-line').textContent = l.lang + ' ¬∑ listed ' + timeAgo(l.listed);
  document.getElementById('detail-lang-badge').textContent = l.lang;
  document.getElementById('detail-desc').textContent = l.desc;
  document.getElementById('detail-avatar').textContent = (seller?.name || '?')[0].toUpperCase();
  document.getElementById('detail-seller-name').textContent = seller?.name || 'Unknown';
  document.getElementById('detail-info-lang').textContent = l.lang;
  document.getElementById('detail-info-date').textContent = timeAgo(l.listed);
  document.getElementById('detail-info-offers').textContent = offerCount;

  // Prices
  document.getElementById('detail-buy-price').textContent = '$' + l.buyPrice;
  const licCard = document.getElementById('price-license-card');
  if (l.licensePrice) {
    licCard.style.display = '';
    document.getElementById('detail-license-price').textContent = '$' + l.licensePrice + '/mo';
  } else {
    licCard.style.display = 'none';
  }

  // Tags
  const tagsEl = document.getElementById('detail-tags');
  tagsEl.innerHTML = (l.tags || []).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('');

  // Code preview ‚Äî show more lines but obfuscate middle
  const lines = l.code.split('\n');
  const preview = isSeller
    ? l.code // seller sees full code
    : lines.slice(0,6).join('\n') + '\n\n' + '// ‚ö†Ô∏è  Full source available after purchase\n\n' + lines.slice(-3).join('\n');
  document.getElementById('detail-code-preview').textContent = preview;

  // Show/hide action sections
  document.getElementById('offer-form-section').style.display = (!currentUser || isSeller) ? 'none' : '';
  document.getElementById('login-prompt-section').style.display = (!currentUser) ? '' : 'none';
  document.getElementById('seller-offers-section').style.display = isSeller ? '' : 'none';

  if (isSeller) renderSellerOffers(listingId);

  showModal('detail-modal');
}

function renderSellerOffers(listingId) {
  const offers = db.offers.filter(o => o.listingId === listingId);
  const el = document.getElementById('seller-offers-list');
  if (offers.length === 0) {
    el.innerHTML = '<div style="color:var(--muted);font-family:\'DM Mono\',monospace;font-size:0.82rem;text-align:center;padding:1.5rem;">No offers yet</div>';
    return;
  }
  el.innerHTML = offers.map(o => {
    const buyer = db.users.find(u => u.id === o.buyerId);
    const badgeClass = o.status === 'accepted' ? 'badge-accepted' : o.status === 'declined' ? 'badge-declined' : 'badge-pending';
    return `
    <div class="offer-item">
      <div class="offer-info">
        <div class="offer-buyer">${buyer?.name || 'Unknown'}</div>
        <span class="offer-type ${o.type === 'buy' ? 'offer-type-buy' : 'offer-type-license'}">${o.type === 'buy' ? 'Full Purchase' : 'License'}</span>
        ${o.message ? `<div style="font-size:0.72rem;color:var(--muted);font-family:'DM Mono',monospace;margin-top:0.3rem;">"${escapeHtml(o.message)}"</div>` : ''}
        ${o.status === 'pending' ? `<div class="offer-actions">
          <button class="btn btn-primary btn-sm" onclick="respondOffer('${o.id}','accepted')">Accept</button>
          <button class="btn btn-danger btn-sm" onclick="respondOffer('${o.id}','declined')">Decline</button>
        </div>` : `<span class="offer-status-badge ${badgeClass}" style="margin-top:0.4rem;display:inline-block;">${o.status}</span>`}
      </div>
      <div class="offer-amount">$${o.amount}</div>
    </div>`;
  }).join('');
}

function respondOffer(offerId, status) {
  const o = db.offers.find(x => x.id === offerId);
  if (o) { o.status = status; save(); }
  renderSellerOffers(currentListingId);
  updateStats();
  toast(status === 'accepted' ? '‚úì Offer accepted!' : 'Offer declined');
}

function submitOffer() {
  if (!currentUser) { toast('‚ùå Sign in first'); return; }
  const l = db.listings.find(x => x.id === currentListingId);
  if (!l) return;
  if (currentUser.id === l.sellerId) { toast("‚ùå Can't offer on your own listing"); return; }
  const type = document.getElementById('offer-type').value;
  const amount = parseFloat(document.getElementById('offer-amount').value);
  const message = document.getElementById('offer-message').value.trim();
  if (!amount || amount < 1) { toast('‚ùå Enter a valid offer amount'); return; }

  // Check for existing pending offer
  const existing = db.offers.find(o => o.listingId === currentListingId && o.buyerId === currentUser.id && o.type === type && o.status === 'pending');
  if (existing) { toast('‚ùå You already have a pending offer of this type'); return; }

  const offer = {
    id: 'o' + Date.now(),
    listingId: currentListingId,
    buyerId: currentUser.id,
    type, amount, message,
    status: 'pending',
    created: Date.now()
  };
  db.offers.push(offer);
  save();
  document.getElementById('offer-amount').value = '';
  document.getElementById('offer-message').value = '';
  updateStats();
  toast('‚úì Offer submitted! The seller will be notified.');
  // Update offer count
  document.getElementById('detail-info-offers').textContent = db.offers.filter(o => o.listingId === currentListingId).length;
}

function quickAction(type) {
  if (!currentUser) { closeModal('detail-modal'); showModal('login-modal'); return; }
  const l = db.listings.find(x => x.id === currentListingId);
  if (!l) return;
  if (currentUser.id === l.sellerId) { toast("That's your listing!"); return; }
  // Pre-fill offer form
  document.getElementById('offer-type').value = type;
  document.getElementById('offer-amount').value = type === 'buy' ? l.buyPrice : (l.licensePrice || '');
  document.getElementById('offer-form-section').scrollIntoView({ behavior: 'smooth' });
  toast('Offer form pre-filled ‚Äî submit to proceed!');
}

// ============================================================
// DASHBOARD
// ============================================================
function showDashboard() {
  renderMyListings();
  renderMyOffers();
  showModal('dashboard-modal');
}

function switchTab(tab) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  event.target.classList.add('active');
}

function renderMyListings() {
  if (!currentUser) return;
  const myListings = db.listings.filter(l => l.sellerId === currentUser.id);
  const el = document.getElementById('my-listings-list');
  if (myListings.length === 0) {
    el.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--muted);font-family:\'DM Mono\',monospace;">No listings yet. Create your first one!</div>';
    return;
  }
  el.innerHTML = myListings.map(l => {
    const offers = db.offers.filter(o => o.listingId === l.id);
    const pending = offers.filter(o => o.status === 'pending').length;
    return `
    <div class="listing-row">
      <span class="lang-badge ${getLangClass(l.lang)}" style="position:static;">${l.lang}</span>
      <div class="listing-row-info">
        <div class="listing-row-title">${escapeHtml(l.title)}</div>
        <div class="listing-row-meta">${offers.length} offers total ¬∑ ${pending} pending ¬∑ Listed ${timeAgo(l.listed)}</div>
      </div>
      <div class="listing-row-price">$${l.buyPrice}</div>
      <div class="listing-row-actions">
        <button class="btn btn-ghost btn-sm" onclick="closeModal('dashboard-modal');openDetail('${l.id}')">View</button>
        <button class="btn btn-danger btn-sm" onclick="deleteListing('${l.id}')">Delete</button>
      </div>
    </div>`;
  }).join('');
}

function deleteListing(listingId) {
  if (!confirm('Delete this listing? This cannot be undone.')) return;
  db.listings = db.listings.filter(l => l.id !== listingId);
  db.offers = db.offers.filter(o => o.listingId !== listingId);
  save();
  renderMyListings();
  renderListings();
  updateStats();
  toast('Listing deleted');
}

function renderMyOffers() {
  if (!currentUser) return;
  const myOffers = db.offers.filter(o => o.buyerId === currentUser.id);
  const el = document.getElementById('my-offers-list');
  if (myOffers.length === 0) {
    el.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--muted);font-family:\'DM Mono\',monospace;">You haven\'t made any offers yet.</div>';
    return;
  }
  el.innerHTML = myOffers.map(o => {
    const l = db.listings.find(x => x.id === o.listingId);
    const seller = l ? db.users.find(u => u.id === l.sellerId) : null;
    const badgeClass = o.status === 'accepted' ? 'badge-accepted' : o.status === 'declined' ? 'badge-declined' : 'badge-pending';
    return `
    <div class="listing-row">
      <div class="listing-row-info">
        <div class="listing-row-title">${l ? escapeHtml(l.title) : '[Deleted listing]'}</div>
        <div class="listing-row-meta">Seller: ${seller?.name || 'unknown'} ¬∑ Type: ${o.type} ¬∑ Submitted ${timeAgo(o.created)}</div>
      </div>
      <div class="listing-row-price">$${o.amount}</div>
      <span class="offer-status-badge ${badgeClass}">${o.status}</span>
    </div>`;
  }).join('');
}

// ============================================================
// STATS
// ============================================================
function updateStats() {
  document.getElementById('stat-listings').textContent = db.listings.length;
  document.getElementById('stat-sellers').textContent = new Set(db.listings.map(l => l.sellerId)).size;
  document.getElementById('stat-offers').textContent = db.offers.length;

  // Update filter badges
  const langs = ['all','JavaScript','Python','TypeScript','CSS','HTML','Other'];
  const fbMap = { all:'fb-all', JavaScript:'fb-js', Python:'fb-py', TypeScript:'fb-ts', CSS:'fb-css', HTML:'fb-html', Other:'fb-other' };
  langs.forEach(lang => {
    const el = document.getElementById(fbMap[lang]);
    if (el) el.textContent = lang === 'all' ? db.listings.length : db.listings.filter(l => l.lang === lang).length;
  });
}

// ============================================================
// MODALS
// ============================================================
function showModal(id) {
  document.getElementById(id).classList.add('open');
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}
// Close on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('open');
  });
});

// ============================================================
// TOAST
// ============================================================
let toastTimer;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 3000);
}

// ============================================================
// UTILS
// ============================================================
function timeAgo(ts) {
  const diff = Date.now() - ts;
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff/60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
  return Math.floor(diff/86400000) + 'd ago';
}

// ============================================================
// INIT
// ============================================================
load();
updateNav();
renderListings();
updateStats();
</script>
</body>
</html>
